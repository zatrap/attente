<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Gestion file dâ€™attente - Version Premium</title>

<style>
html, body { margin:0; padding:0; height:100%; font-family:'Segoe UI', sans-serif; }

body.control-mode { 
  background: linear-gradient(to bottom, #e0f0ff, #ffffff); 
  padding:20px; 
}

.container { 
  max-width:950px; 
  margin:auto; 
  background:#ffffffee; 
  padding:30px; 
  border-radius:15px; 
  box-shadow:0 10px 30px rgba(0,0,0,0.2);
}

button { 
  padding:10px 18px; 
  margin:5px; 
  border:none; 
  border-radius:8px; 
  background:#007aff; 
  color:white; 
  cursor:pointer;
  transition:0.2s;
}
button:hover { transform:scale(1.05); background:#005ecb;}

.absentBtn{ background:#ff4d4d; }
.absentBtn:hover{ background:#cc0000; }

.recallBtn{ background:#ffaa00; }
.recallBtn:hover{ background:#cc8400; }

input[type=number], select{
  padding:10px;
  border-radius:8px;
  border:2px solid #007aff;
  margin:5px;
}

/* ================= PUBLIC ================= */
body.public-mode{
  background: linear-gradient(180deg, #00111f, #000000);
  overflow:hidden;
  color:white;
}

#pub{
  height:100vh;
  display:flex;
  flex-direction:column;
  justify-content:space-between;
  align-items:center;
  padding:40px 20px;
  box-sizing:border-box;
}

#title{ font-size:3vw; opacity:0.8; }

#centerZone{
  flex:1;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
}

#publicNumber{
  font-size:18vw;
  text-shadow:0 0 40px cyan;
  transition:0.3s;
}

#status{
  font-size:4vw;
  margin-top:10px;
}

#lastCalls{
  display:flex;
  gap:25px;
  flex-wrap:wrap;
  justify-content:center;
  font-size:1.8vw;
}

.callItem{
  background:rgba(255,255,255,0.07);
  padding:10px 20px;
  border-radius:10px;
  min-width:220px;
}

#fullscreenBtn {
  position:absolute;
  bottom:10px;
  right:10px;
  opacity:0.3;
}

</style>
</head>

<body class="control-mode">

<div class="container">
<h1 style="text-align:center;">ðŸŽ¯ Gestion file dâ€™attente Premium</h1>

<div id="bureauContainer"></div>

<div style="text-align:center;margin-top:20px;">
<button onclick="next()">Suivant (Comptoir)</button>
<button class="absentBtn" onclick="markAbsent()">Absent</button>
<button onclick="openPublic()">Ã‰cran public</button>
<button onclick="toggleSound()" id="soundBtn">ðŸ”Š Son activÃ©</button>
</div>

<div style="text-align:center;margin-top:20px;">
<select id="manualSource">
<option value="Comptoir">Comptoir</option>
<option value="Bureau 1">Bureau 1</option>
<option value="Bureau 2">Bureau 2</option>
<option value="Bureau 3">Bureau 3</option>
<option value="Sous-sol">Sous-sol</option>
</select>

<select id="manualType">
<option value="">-- Motif --</option>
<option value="Saisie">Saisie</option>
<option value="Finalisation">Finalisation</option>
</select>

<input type="number" id="manualNumber" placeholder="NumÃ©ro">
<button onclick="manual()">Appeler</button>
</div>

<h3>NumÃ©ros absents</h3>
<div id="absentList"></div>

<h3>Historique (10 derniers)</h3>
<div id="history"></div>

</div>

<script>

const channel = new BroadcastChannel("queue_channel");

const bureauNames = {
  1: "Bureau 1",
  2: "Bureau 2",
  3: "Bureau 3",
  4: "Sous-sol"
};

let current=0;
let history=[];
let absents=[];
let lastCalls=[];
let soundEnabled=true;

function initBureaux(){
  const container=document.getElementById("bureauContainer");
  container.innerHTML="";
  for(let i=1;i<=4;i++){
    const div=document.createElement("div");
    div.innerHTML=`<strong>${bureauNames[i]}</strong> 
<button onclick="callBureau(${i})">Appeler</button>`;
    container.appendChild(div);
  }
}

function speakNumber(number, source){
  if(!soundEnabled) return;
  const msg=new SpeechSynthesisUtterance(
    `NumÃ©ro ${number}, veuillez vous prÃ©senter au ${source}`
  );
  msg.lang="fr-FR";
  speechSynthesis.speak(msg);
}

function updateHistory(){
  document.getElementById("history").innerHTML=
    history.slice(-10).reverse()
    .map(h=>`<div>#${h.number} - ${h.status} (${h.source})</div>`).join("");

  document.getElementById("absentList").innerHTML=
    absents.map(n=>`<button class="recallBtn" onclick="recall(${n})">Rappeler #${n}</button>`).join("");
}

function broadcast(number, source, status="servi"){
  lastCalls.unshift({number, source});
  if(lastCalls.length>4) lastCalls.pop();
  channel.postMessage({number, source, status, lastCalls});
}

function next(){
  current++;
  history.push({number:current, status:"servi", source:"Comptoir"});
  updateHistory();
  broadcast(current,"Comptoir");
  speakNumber(current,"Comptoir");
}

function markAbsent(){
  if(history.length===0) return;
  const last=history[history.length-1];
  last.status="absent";
  absents.push(last.number);
  updateHistory();
  broadcast(last.number,last.source,"absent");
}

function recall(n){
  absents=absents.filter(x=>x!==n);
  history.push({number:n,status:"rappel",source:"Comptoir"});
  updateHistory();
  broadcast(n,"Comptoir");
  speakNumber(n,"Comptoir");
}

function manual(){
  const n=parseInt(document.getElementById("manualNumber").value);
  if(!n) return alert("NumÃ©ro invalide");

  const source=document.getElementById("manualSource").value;
  const type=document.getElementById("manualType").value;
  const label= type?`${source} - ${type}`:source;

  current=n;
  history.push({number:n,status:"manuel",source:label});
  updateHistory();
  broadcast(n,label);
  speakNumber(n,label);

  document.getElementById("manualNumber").value="";
}

function callBureau(id){
  current++;
  const source=bureauNames[id];
  history.push({number:current,status:"servi",source});
  updateHistory();
  broadcast(current,source);
  speakNumber(current,source);
}

function toggleSound(){
  soundEnabled=!soundEnabled;
  document.getElementById("soundBtn").textContent=
    soundEnabled?"ðŸ”Š Son activÃ©":"ðŸ”‡ Son dÃ©sactivÃ©";
}

function openPublic(){
  window.open(location.href+"?public=1","_blank");
}

/* ================= PUBLIC ================= */

if(location.search.includes("public=1")){
  document.body.className="public-mode";

  document.body.innerHTML=`
  <div id="pub">
    <div id="title">NUMÃ‰RO EN COURS</div>

    <div id="centerZone">
        <div id="publicNumber">0</div>
        <div id="status"></div>
    </div>

    <div id="lastCalls"></div>

    <button id="fullscreenBtn" onclick="document.documentElement.requestFullscreen()">Plein Ã©cran</button>
  </div>
  `;

  channel.onmessage=(e)=>{
    const num=e.data.number;
    const source=e.data.source;
    const status=e.data.status;
    const list=e.data.lastCalls;

    document.getElementById("publicNumber").textContent=num;

    if(status==="absent"){
      document.getElementById("status").textContent="ABSENT";
      document.getElementById("status").style.color="gray";
    }else{
      document.getElementById("status").textContent=source;
      document.getElementById("status").style.color="white";
    }

    document.getElementById("lastCalls").innerHTML=
      list.map(c=>`<div class="callItem">#${c.number} â†’ ${c.source}</div>`).join("");
  };
}

initBureaux();
updateHistory();

</script>
</body>
</html>
