<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Gestion file dâ€™attente Premium</title>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAnaaDFSoR4TQeBT-GsePWh4NZ837zptcI",
  authDomain: "attente-a4b23.firebaseapp.com",
  projectId: "attente-a4b23",
  storageBucket: "attente-a4b23.firebasestorage.app",
  messagingSenderId: "305708504065",
  appId: "1:305708504065:web:10979176a13a4fb3829c00",
  measurementId: "G-QG0FXPWTG2"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let current = 0;
let history = [];
let absents = [];
let lastCalls = [];
let soundEnabled = true;

function speakNumber(number, source){
  if(!soundEnabled) return;
  const msg=new SpeechSynthesisUtterance(
    `NumÃ©ro ${number}, veuillez vous prÃ©senter au ${source}`
  );
  msg.lang="fr-FR";
  speechSynthesis.speak(msg);
}

async function saveToFirebase(number, source, status="servi"){
  lastCalls.unshift({number, source});
  if(lastCalls.length>4) lastCalls.pop();

  await setDoc(doc(db,"queue","current"),{
    number,
    source,
    status,
    lastCalls
  });
}

window.next = async function(){
  current++;
  history.push({number:current,status:"servi",source:"Comptoir"});
  await saveToFirebase(current,"Comptoir");
  speakNumber(current,"Comptoir");
}

window.markAbsent = async function(){
  if(history.length===0) return;
  const last=history[history.length-1];
  last.status="absent";
  absents.push(last.number);
  await saveToFirebase(last.number,last.source,"absent");
}

window.manual = async function(){
  const n=parseInt(document.getElementById("manualNumber").value);
  if(!n) return alert("NumÃ©ro invalide");

  const source=document.getElementById("manualSource").value;
  const type=document.getElementById("manualType").value;
  const label= type?`${source} - ${type}`:source;

  current=n;
  history.push({number:n,status:"manuel",source:label});
  await saveToFirebase(n,label);
  speakNumber(n,label);

  document.getElementById("manualNumber").value="";
}

window.toggleSound = function(){
  soundEnabled=!soundEnabled;
  document.getElementById("soundBtn").textContent=
    soundEnabled?"ðŸ”Š Son activÃ©":"ðŸ”‡ Son dÃ©sactivÃ©";
}

window.openPublic = function(){
  window.open(location.href+"?public=1","_blank");
}

/* ================= PUBLIC ================= */

if(location.search.includes("public=1")){
  document.body.innerHTML=`
  <div style="background:black;color:white;height:100vh;
  display:flex;flex-direction:column;align-items:center;justify-content:center;">
    <h1>NUMÃ‰RO EN COURS</h1>
    <div id="publicNumber" style="font-size:150px;">0</div>
    <div id="status" style="font-size:40px;"></div>
    <div id="lastCalls" style="margin-top:40px;"></div>
  </div>
  `;

  onSnapshot(doc(db,"queue","current"),(docSnap)=>{
    if(docSnap.exists()){
      const data=docSnap.data();
      document.getElementById("publicNumber").textContent=data.number;

      if(data.status==="absent"){
        document.getElementById("status").textContent="ABSENT";
        document.getElementById("status").style.color="gray";
      }else{
        document.getElementById("status").textContent=data.source;
        document.getElementById("status").style.color="white";
      }

      document.getElementById("lastCalls").innerHTML=
        data.lastCalls.map(c=>
          `<div>#${c.number} â†’ ${c.source}</div>`
        ).join("");
    }
  });
}
</script>
</head>

<body>

<h1>ðŸŽ¯ Gestion file dâ€™attente Premium</h1>

<button onclick="next()">Suivant</button>
<button onclick="markAbsent()">Absent</button>
<button onclick="openPublic()">Ã‰cran public</button>
<button onclick="toggleSound()" id="soundBtn">ðŸ”Š Son activÃ©</button>

<br><br>

<select id="manualSource">
<option value="Comptoir">Comptoir</option>
<option value="Bureau 1">Bureau 1</option>
<option value="Bureau 2">Bureau 2</option>
<option value="Bureau 3">Bureau 3</option>
<option value="Sous-sol">Sous-sol</option>
</select>

<select id="manualType">
<option value="">-- Motif --</option>
<option value="Saisie">Saisie</option>
<option value="Finalisation">Finalisation</option>
</select>

<input type="number" id="manualNumber" placeholder="NumÃ©ro">
<button onclick="manual()">Appeler</button>

</body>
</html>
