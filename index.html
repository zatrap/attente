<!DOCTYPE html> 
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Gestion file dâ€™attente - Version Premium</title>
 
<style>
html, body { margin:0; padding:0; height:100%; font-family:'Segoe UI', sans-serif; }
 
body.control-mode { 
  background: linear-gradient(to bottom, #e0f0ff, #ffffff); 
  padding:20px; 
}
 
.container { 
  max-width:950px; 
  margin:auto; 
  background:#ffffffee; 
  padding:30px; 
  border-radius:15px; 
  box-shadow:0 10px 30px rgba(0,0,0,0.2);
}
 
button { 
  padding:10px 18px; 
  margin:5px; 
  border:none; 
  border-radius:8px; 
  background:#007aff; 
  color:white; 
  cursor:pointer;
  transition:0.2s;
}
button:hover { transform:scale(1.05); background:#005ecb;}
 
.absentBtn{ background:#ff4d4d; }
.absentBtn:hover{ background:#cc0000; }
 
.recallBtn{ background:#ffaa00; }
.recallBtn:hover{ background:#cc8400; }
 
input[type=number], select{
  padding:10px;
  border-radius:8px;
  border:2px solid #007aff;
  margin:5px;
}
 
/* ================= PUBLIC ================= */
body.public-mode{
  background: linear-gradient(180deg, #00111f, #000000);
  overflow:hidden;
  color:white;
}
 
#pub{
  height:100vh;
  display:flex;
  flex-direction:column;
  justify-content:space-between;
  align-items:center;
  padding:40px 20px;
  box-sizing:border-box;
  position:relative;
}
 
#title{ font-size:3vw; opacity:0.8; }
 
#centerZone{
  flex:1;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
}
 
#publicNumber{
  font-size:18vw;
  text-shadow:0 0 40px cyan;
}
 
#status{
  font-size:4vw;
  margin-top:10px;
}
 
#lastCalls{
  display:flex;
  gap:25px;
  flex-wrap:wrap;
  justify-content:center;
  font-size:1.8vw;
}
 
.callItem{
  background:rgba(255,255,255,0.07);
  padding:10px 20px;
  border-radius:10px;
  min-width:220px;
}
 
#fullscreenBtn {
  position:absolute;
  bottom:10px;
  right:10px;
  opacity:0.3;
}

#datetime{
  position:absolute;
  top:20px;
  right:30px;
  text-align:right;
  font-size:1.5vw;
}

#day{
  font-size:1.2vw;
  opacity:0.7;
}

#qrZone{
  position:absolute;
  left:30px;
  top:50%;
  transform:translateY(-50%);
  text-align:center;
}

#qrZone img{
  width:140px;
  background:white;
  padding:10px;
  border-radius:12px;
}
</style>
</head>
 
<body class="control-mode">
 
<div class="container">
<h1 style="text-align:center;">ðŸŽ¯ Gestion file dâ€™attente Premium</h1>
 
<div style="text-align:center;margin-top:20px;">
<button onclick="next()">Suivant (Comptoir)</button>
<button class="absentBtn" onclick="markAbsent()">Absent</button>
<button onclick="openPublic()">Ã‰cran public</button>
</div>

<h3>Historique</h3>
<div id="history"></div>
</div>
 
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
 
const firebaseConfig = {
  apiKey: "AIzaSy...",
  authDomain: "attente-a4b23.firebaseapp.com",
  projectId: "attente-a4b23"
};
 
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
 
let current=0, history=[], lastCalls=[];
 
async function broadcastFirebase(number, source, status="servi"){
  lastCalls.unshift({number, source});
  if(lastCalls.length>4) lastCalls.pop();
  await setDoc(doc(db,"queue","current"), {number, source, status, lastCalls});
}
 
window.next = async function(){
  current++;
  history.push({number:current,source:"Comptoir"});
  await broadcastFirebase(current,"Comptoir");
  updateHistory();
}
 
window.markAbsent = async function(){
  if(history.length===0) return;
  const last=history[history.length-1];
  await broadcastFirebase(last.number,last.source,"absent");
}
 
window.openPublic = function(){
  window.open(location.origin + location.pathname + "?public=1","_blank");
}
 
if(location.search.includes("public=1")){
  document.body.className="public-mode";
  document.body.innerHTML=`
<div id="pub">

<div id="datetime">
  <div id="clock"></div>
  <div id="day"></div>
</div>

<div id="qrZone">
  <img id="qrCode">
</div>

<div id="title">NUMÃ‰RO EN COURS</div>

<div id="centerZone">
<div id="publicNumber">0</div>
<div id="status"></div>
</div>

<div id="lastCalls"></div>

<button id="fullscreenBtn" onclick="document.documentElement.requestFullscreen()">Plein Ã©cran</button>
</div>`;

  function updateClock(){
    const now=new Date();
    document.getElementById("clock").textContent=
      now.toLocaleTimeString('fr-FR');
    document.getElementById("day").textContent=
      now.toLocaleDateString('fr-FR',
      {weekday:'long',year:'2-digit',month:'long',day:'numeric'});
  }
  setInterval(updateClock,1000);
  updateClock();

  onSnapshot(doc(db,"queue","current"),(docSnap)=>{
    if(docSnap.exists()){
      const data=docSnap.data();
      document.getElementById("publicNumber").textContent=data.number;
      document.getElementById("status").textContent=data.source;

      document.getElementById("lastCalls").innerHTML=
        data.lastCalls.map(c=>`<div class="callItem">#${c.number} â†’ ${c.source}</div>`).join("");

      /* âœ… QR corrigÃ© */
      const baseUrl = location.origin + location.pathname;
      const qrData = baseUrl + "?public=1&numero=" + data.number;

      document.getElementById("qrCode").src =
      "https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=" + encodeURIComponent(qrData);
    }
  });
}
 
function updateHistory(){
  document.getElementById("history").innerHTML=
    history.map(h=>`<div>#${h.number} - ${h.source}</div>`).join("");
}
 
updateHistory();
</script>
</body>
</html>
